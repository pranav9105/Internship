
/**
 * This ruleset enforces a hybrid security model for a travel application.
 *
 * Core Philosophy:
 * The security model separates public, browseable content from private, user-specific data.
 * Public data is readable by everyone but is not writable from the client-side,
 * ensuring content integrity. Private user data is strictly controlled, allowing users
 * access only to their own information.
 *
 * Data Structure:
 * - Public data, such as `/destinations` and `/travelPackages`, is stored in top-level collections.
 * - All private user data is nested under a single user-specific path: `/users/{userId}`.
 *   This includes user profiles, booking inquiries, and recommendations. This structure
 *   leverages path-based security to simplify and strengthen ownership rules.
 *
 * Key Security Decisions:
 * - Admin-Managed Content: The public `/destinations` and `/travelPackages` collections
 *   are read-only for clients. It is assumed that this data is managed by a trusted
 *   backend service using the Admin SDK.
 * - Strict User Ownership: A user can only access documents within their own data tree
 *   (e.g., `/users/{their-own-id}/...`).
 * - No User Listing: To protect user privacy, it is impossible for any client to list
 *   all documents in the top-level `/users` collection.
 * - Read-Only Subcollections: Certain user-specific data, like `/recommendations`, is
 *   considered read-only for the user, as it is generated by a backend process.
 *
 * Denormalization for Authorization:
 * To maintain performance and security, documents within a user's data tree (e.g., a
 * BookingInquiry) contain a denormalized `userId` field. Security rules validate on
 * creation that this internal `userId` matches the `{userId}` in the path, creating a
 * permanent and immutable link that proves ownership without requiring extra database reads.
 *
 * Structural Segregation:
 * The separation of public collections (e.g., `/destinations`) from private user
 * subcollections (e.g., `/users/{userId}/bookingInquiries`) is a deliberate design choice.
 * This segregation ensures that queries for public data do not risk exposing private
 * information and simplifies the rules for list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Returns true if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * This is the core function for validating ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is the owner of an existing document.
     * Used for update and delete operations to prevent writes on non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the user profile being created has an `id` field
     * that matches the user's authentication UID.
     */
    function isCreatingOwnProfile(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Enforces immutability of the user profile's `id` field during an update.
     */
    function isUpdatingOwnProfile() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that a booking inquiry being created has a `userId` field
     * that matches the user's authentication UID.
     */
    function isCreatingOwnInquiry(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * Enforces immutability of the booking inquiry's `userId` field during an update.
     */
    function isUpdatingOwnInquiry() {
      return request.resource.data.userId == resource.data.id;
    }


    // --------------------------------------------------------------------
    // Public Collections
    // --------------------------------------------------------------------

    /**
     * @description Publicly readable destination data. Client-side writes are disallowed
     *              to ensure data integrity, assuming content is managed by an admin backend.
     * @path        /destinations/{destinationId}
     * @allow       (get, list) Any user, signed-in or anonymous, can read destinations.
     * @deny        (create, update, delete) Any client attempting to modify a destination.
     * @principle   Protects public content from modification by clients.
     */
    match /destinations/{destinationId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Publicly readable travel package data. Client-side writes are disallowed.
     * @path        /travelPackages/{travelPackageId}
     * @allow       (get, list) Any user, signed-in or anonymous, can read travel packages.
     * @deny        (create, update, delete) Any client attempting to modify a travel package.
     * @principle   Protects public content from modification by clients.
     */
    match /travelPackages/{travelPackageId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
    
    /**
     * @description Anonymous users can submit inquiries. Logged-in users' inquiries
     * are stored in their own subcollection.
     */
    match /inquiries/{inquiryId} {
        allow create: if !isSignedIn();
        allow read, update, delete: if false;
    }


    // --------------------------------------------------------------------
    // User-Owned Data
    // --------------------------------------------------------------------

    /**
     * @description Manages user profiles and serves as the root for all user-owned data.
     *              A user can create their own profile, and then only they can access or modify it.
     * @path        /users/{userId}
     * @allow       (create) A new user whose auth UID matches {userId} can create their profile.
     * @allow       (get, update, delete) An existing user can read, update, or delete their own profile.
     * @deny        User 'A' trying to read, write, or list any data belonging to user 'B'.
     * @deny        (list) Listing all users is disabled to protect user privacy.
     * @principle   Enforces a strict user-ownership model for private data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isCreatingOwnProfile(userId);
      allow update: if isExistingOwner(userId) && isUpdatingOwnProfile();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Users can create and manage their own booking inquiries. Access is
       *              restricted to the owner of the parent user profile.
       * @path        /users/{userId}/bookingInquiries/{bookingInquiryId}
       * @allow       (create, get, list, update, delete) User 'A' can manage their own inquiries under `/users/A/bookingInquiries/...`.
       * @deny        User 'B' trying to access anything under `/users/A/...`.
       * @principle   Restricts access to a user's own data subtree using path-based security.
       */
      match /bookingInquiries/{bookingInquiryId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && isCreatingOwnInquiry(userId);
        allow update, delete: if isExistingOwner(userId);
      }

      /**
       * @description Users can read personalized recommendations generated for them.
       *              Writes are disabled as recommendations are created by a backend process.
       */
      match /recommendations/{recommendationId} {
        allow get, list: if isOwner(userId);
        allow create, update, delete: if false;
      }
      
      /**
       * @description Users can manage their own trip data.
       */
      match /trips/{tripId} {
        allow read, write: if isOwner(userId);
      }

      /**
       * @description Users can manage their own booking data.
       */
      match /bookings/{bookingId} {
        allow read, write: if isOwner(userId);
      }

      /**
       * @description Users can manage their own wishlist.
       */
      match /wishlist/{wishlistItemId} {
        allow read, write: if isOwner(userId);
      }

      /**
       * @description Rewards data is read-only for the user. It is managed
       *              by a backend process.
       */
      match /rewards/{rewardId} {
        allow read: if isOwner(userId);
        allow create, update, delete: if false;
      }
    }
  }
}
